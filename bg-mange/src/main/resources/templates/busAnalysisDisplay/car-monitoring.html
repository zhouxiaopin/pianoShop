<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,height=device-height, minimum-scale=1.0, maximum-scale=1.0">
    <title>车辆监控</title>
    <link rel="stylesheet" type="text/css" th:href="@{/static/busAnalysisDisplay/css/style.css}" />
    <link rel="stylesheet" th:href="@{/static/jeasyui/themes/cyan/easyui.css}" type="text/css"/>
    <link rel="stylesheet" th:href="@{/static/jeasyui/themes/color.css}" type="text/css" />
    <link rel="stylesheet" th:href="@{/static/jeasyui/themes/icon.css}" type="text/css" />
    <script  th:src="@{/static/busAnalysisDisplay/js/jquery-1.11.1.min.js}"></script>
    <script type="text/javascript">
        (function(){
            function sizeHtml(){
                window.mtSizeBase = $(window).width()/32;
                //window.mtSizeBase = window.mtSizeBase>45?45:window.mtSizeBase;
                $("html").css("font-size",window.mtSizeBase+"px");
            }
            sizeHtml();
            $(window).resize(function(){
                setTimeout(function(){
                    sizeHtml();
                },300);
            });
        })();
</script>
</head>
<body class="common-bg" style="overflow:hidden;">
    <h3 class="head-img"></h3> 
    <div class="content-body">
        <div class="nav-crosswise">
            <div class="nav-crosswise-main c-fff"><span>当前位置</span>><span>地图展示</span>><span>车辆监控</span></div>
        </div>
        <div class="main-area clearfix">
            <div class="lengthways-nav fl" id="side-menu">
                <div class="map-show-nav selected">
                    <ul>
                        <li class="active">
                            <span class="J_menuItem"><img th:src="@{/static/busAnalysisDisplay/images/quan.png}">地图展示</span>
                            <ul>
                                <li><a href="traffic-monitoring.html" th:href="@{/page/passengerFlowMonitor}">客流监控</a></li>
                                <li><a href="javascript:;" class="on">车辆监控</a></li>
                                <li><a href="car-transfer.html" th:href="@{/page/busTransform}">车辆换乘</a></li>
                                <li><a href="od-fenbu.html" th:href="@{/page/regionODDistri}">区域OD分布</a></li>
                                <li><a href="alarm-msg.html" th:href="@{/page/alarmMsg}">报警信息</a></li>
                            </ul>
                        </li>
                        <li >
                            <span class="J_menuItem"><img th:src="@{/static/busAnalysisDisplay/images/quan.png}">数据分析</span>
                            <ul>
                                <li>
                                    <span class="J_menuItem">公交客运</span>
                                    <ul>
                                        <li><a href="passenger-form.html" th:href="@{/page/passenVolumeCons}">客运量构成</a></li>
                                        <li><a href="brush-card-number.html" th:href="@{/page/swingCardVolumeStati}">刷卡量统计</a></li>
                                    </ul>
                                </li>
                                <li>
                                    <span class="J_menuItem">公交运行</span>
                                    <ul>
                                        <li><a href="gaofeng-chart.html" th:href="@{/page/peakRun}">高峰运行图</a></li>
                                        <li><a href="running-speed-chart.html" th:href="@{/page/runSpeedStati}">运行速度统计</a></li>
                                        <li><a href="traffic-zhishu.html" th:href="@{/page/trafficNum}">交通指数</a></li>
                                        <li><a href="traffic-routes.html" th:href="@{/page/congestionRoad}">拥堵路段</a></li>
                                    </ul>
                                </li>
                                <li>
                                    <span class="J_menuItem">换乘分析</span>
                                    <ul>
                                        <li><a href="transfer-form.html" th:href="@{/page/transChangeCons}">换乘量构成</a></li>
                                        <li><a href="transfer-tongji.html" th:href="@{/page/transChangeStati}">换乘量统计</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
                
            </div>
            <div class="map-area fr " id="content">
                <!--<div class="online-car-msg">-->
                    <!--<div>粤A123456    24.32km/h</div>-->
                    <!--<div>532路（上行） | 一汽一公司 | 邓某某</div>-->
                    <!--<div>当前站点：体育中心站</div>-->
                    <!--<div>当前刷卡量：4852人次</div>-->
                    <!--<em></em>-->
                <!--</div>-->
                <!--<img src="images/map.jpg" alt="" />-->
                <!--#######################################-->

                <!--地图开始-->
                <div id="busMonitorMap" class="mapStyle">
                </div>
                <!--地图结束-->
                <div class="icon-explain">
                    <div class="red-car"><img src="images/red-car.png" th:src="@{/static/busAnalysisDisplay/images/red-car.png}" />终端在线车辆</div>
                    <div><img src="images/yellow-car.png" th:src="@{/static/busAnalysisDisplay/images/yellow-car.png}"/>终端非在线车辆</div>
                </div>
                <div class="rank-pup" id="pup">
                    <div class="car-num">
                        <ul class="clearfix">
                            <li class="num-name">车辆总数</li>
                            <li class="car-num-bar"><div class="car-num-bar-inner" style="width: 95%"></div></li>
                            <li><span id="busSum">0</span>辆</li>
                        </ul>
                        <ul class="clearfix">
                            <li class="num-name">终端在线车辆数</li>
                            <li class="car-num-bar"><div id="terminalOnlineBusSumBar" class="car-num-bar-inner"></div></li>
                            <li><span id="terminalOnlineBusSum">28.24</span>辆</li>
                        </ul>
                        <ul class="clearfix">
                            <li class="num-name">终端非在线车辆数</li>
                            <li class="car-num-bar"><div id="terminalOfflineBusSumBar" class="car-num-bar-inner"></div></li>
                            <li><span id="terminalOfflineBusSum">28.24</span>辆</li>
                        </ul>
                    </div>
                    <div class="search">
                        <input type="search" id="searchInput" name="" placeholder="车辆编号" />
                        <!--搜索框模糊查询hint开始-->
                        <div id="searchHintArea" style="display: none">
                            <section>
                                <table id="searchHintTable">
                                    <tbody>
                                    </tbody>
                                </table>
                            </section>
                        </div>
                        <!--搜索框模糊查询hint结束-->
                    </div>
                    <div class="rank-title">车辆在线数排名 TOP10</div>
                    <ul class="top-ul">
                        <li  class="active"><span>站点</span></li>
                        <li><span>线路</span></li>
                    </ul>
                    <ul class="rank-data">
                        <li>
                            <ul id="stationBusOnlineTop10" class="progress-wrap">
                                <li>
                                    <span class="rank-num"><em>1</em></span>
                                    <div class="progress">
                                        <div class="info">
                                            <span class="name"  title="珠江新城站珠江新城站">珠江新城站珠江新城站</span>
                                            <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-inner">
                                                <!-- <div class="progress-inner"></div> -->
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <span class="rank-num"><em>2</em></span>
                                    <div class="progress">
                                        <div class="info">
                                            <span class="name"  title="珠江新城站">珠江新城站</span>
                                            <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-inner">
                                                <!-- <div class="progress-inner"></div> -->
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <span class="rank-num"><em>3</em></span>
                                    <div class="progress">
                                        <div class="info">
                                            <span class="name"  title="珠江新城站">珠江新城站</span>
                                            <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-inner">
                                                <!-- <div class="progress-inner"></div> -->
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <span class="rank-num"><em>4</em></span>
                                    <div class="progress">
                                        <div class="info">
                                            <span class="name"  title="珠江新城站">珠江新城站</span>
                                            <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-inner">
                                                <!-- <div class="progress-inner"></div> -->
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <span class="rank-num"><em>5</em></span>
                                    <div class="progress">
                                        <div class="info">
                                            <span class="name"  title="珠江新城站">珠江新城站</span>
                                            <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-inner">
                                                <!-- <div class="progress-inner"></div> -->
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <span class="rank-num"><em>6</em></span>
                                    <div class="progress">
                                        <div class="info">
                                            <span class="name"  title="珠江新城站">珠江新城站</span>
                                            <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-inner">
                                                <!-- <div class="progress-inner"></div> -->
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <span class="rank-num"><em>7</em></span>
                                    <div class="progress">
                                        <div class="info">
                                            <span class="name"  title="珠江新城站">珠江新城站</span>
                                            <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-inner">
                                                <!-- <div class="progress-inner"></div> -->
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <span class="rank-num"><em>8</em></span>
                                    <div class="progress">
                                        <div class="info">
                                            <span class="name"  title="珠江新城站">珠江新城站</span>
                                            <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-inner">
                                                <!-- <div class="progress-inner"></div> -->
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <span class="rank-num"><em>9</em></span>
                                    <div class="progress">
                                        <div class="info">
                                            <span class="name"  title="珠江新城站">珠江新城站</span>
                                            <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-inner">
                                                <!-- <div class="progress-inner"></div> -->
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <span class="rank-num"><em>10</em></span>
                                    <div class="progress">
                                        <div class="info">
                                            <span class="name"  title="珠江新城站">珠江新城站</span>
                                            <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-inner">
                                                <!-- <div class="progress-inner"></div> -->
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            </ul>                           
                        </li>
                        <li>
                        <ul id="lineBusOnlineTop10" class="progress-wrap">
                                <li>
                                    <span class="rank-num"><em>1</em></span>
                                    <div class="progress">
                                        <div class="info">
                                            <span class="name"  title="珠江新城站">珠江新城线</span>
                                            <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-inner">
                                                <!-- <div class="progress-inner"></div> -->
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <span class="rank-num"><em>2</em></span>
                                    <div class="progress">
                                        <div class="info">
                                            <span class="name"  title="珠江新城站">珠江新城线</span>
                                            <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-inner">
                                                <!-- <div class="progress-inner"></div> -->
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <span class="rank-num"><em>3</em></span>
                                    <div class="progress">
                                        <div class="info">
                                            <span class="name"  title="珠江新城站">珠江新城线</span>
                                            <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-inner">
                                                <!-- <div class="progress-inner"></div> -->
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <span class="rank-num"><em>4</em></span>
                                    <div class="progress">
                                        <div class="info">
                                            <span class="name"  title="珠江新城站">珠江新城线</span>
                                            <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-inner">
                                                <!-- <div class="progress-inner"></div> -->
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <span class="rank-num"><em>5</em></span>
                                    <div class="progress">
                                        <div class="info">
                                            <span class="name"  title="珠江新城站">珠江新城线</span>
                                            <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-inner">
                                                <!-- <div class="progress-inner"></div> -->
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <span class="rank-num"><em>6</em></span>
                                    <div class="progress">
                                        <div class="info">
                                            <span class="name"  title="珠江新城站">珠江新城线</span>
                                            <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-inner">
                                                <!-- <div class="progress-inner"></div> -->
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <span class="rank-num"><em>7</em></span>
                                    <div class="progress">
                                        <div class="info">
                                            <span class="name"  title="珠江新城站">珠江新城线</span>
                                            <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-inner">
                                                <!-- <div class="progress-inner"></div> -->
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <span class="rank-num"><em>8</em></span>
                                    <div class="progress">
                                        <div class="info">
                                            <span class="name"  title="珠江新城站">珠江新城线</span>
                                            <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-inner">
                                                <!-- <div class="progress-inner"></div> -->
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <span class="rank-num"><em>9</em></span>
                                    <div class="progress">
                                        <div class="info">
                                            <span class="name"  title="珠江新城站">珠江新城线</span>
                                            <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-inner">
                                                <!-- <div class="progress-inner"></div> -->
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <span class="rank-num"><em>10</em></span>
                                    <div class="progress">
                                        <div class="info">
                                            <span class="name"  title="珠江新城站">珠江新城线</span>
                                            <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-inner">
                                                <!-- <div class="progress-inner"></div> -->
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            </ul>                            
                        </li>
                    </ul>

                </div>
            </div>
        </div>
    </div>
</body>

<script type="text/javascript" th:replace="common/fragment :: commonVar"></script>
<script type="text/javascript" th:src="@{/static/jeasyui/jquery.easyui.min.js}"></script>
<script type="text/javascript" th:src="@{/static/jeasyui/locale/easyui-lang-zh_CN.js}"></script>

<script type="text/javascript" th:src="@{/static/js/echarts/echarts.min.js}"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=fdv5gclnF2HSnNyKm4Dj3aVuLUGMLUZ1" ></script>
<script type="text/javascript" src="http://api.map.baidu.com/library/InfoBox/1.2/src/InfoBox_min.js" ></script>
<!--<script type="text/javascript" src="http://api.map.baidu.com/library/TextIconOverlay/1.2/src/TextIconOverlay_min.js" ></script>-->
<!--<script type="text/javascript" src="http://api.map.baidu.com/library/MarkerClusterer/1.2/src/MarkerClusterer_min.js"></script>-->
<script  th:src="@{/static/js/baiduMap/TextIconOverlay_min.js}"></script>
<script  th:src="@{/static/js/baiduMap/MarkerClusterer_min.js}"></script>
<script  th:src="@{/static/busAnalysisDisplay/js/baiduMapStyle.js}"></script>
<script type="text/javascript" th:src="@{/static/js/prototypeExpand.js}"></script>
<script  th:src="@{/static/js/baiduMapCommon.js}"></script>
<script  th:src="@{/static/busAnalysisDisplay/js/jqueryExtend.js}"></script>
<script  th:src="@{/static/js/ticcCommon.js}"></script>
<script type="text/javascript">
    //下面是页面的
    $(function(){
        var body = (document.compatMode && document.compatMode.toLowerCase() == "css1compat") ? document.documentElement : document.body;

        function ResizeTable() {
            var sideWidth = document.getElementById("side-menu");
            var con = document.getElementById('content');
            var pup = document.getElementById('pup');
            var pupH = pup.clientHeight;

            sideWidth.style.height = '' + Math.max((body.clientHeight - 100), 0) + "px";
            con.style.height = '' + Math.max((body.clientHeight - 100), 0) + "px";
            con.style.width = '' + Math.max((body.clientWidth - 180), 0) + "px";
            pup.style.top = '' + Math.max((body.clientHeight - pupH)/2, 0) + "px";


            var pro = Math.max((con.clientHeight - 100-300), 0) + "px";
            $(".progress-wrap").css("height",pro)
        }
        ResizeTable();

        $(window).resize(function () {
            ResizeTable()
        });

        var $item = $(".J_menuItem");
        $item.on("click",function(){
            var $this = $(this);
            $this.siblings("ul").slideToggle(300);
            $this.parent("li").siblings("li").find("ul").slideUp(300);
            $this.parent("li").addClass("active").siblings("li").removeClass("active");
        })


        $(".top-ul li").click(function() {
            var index = $(this).index();
            $(this).addClass('active').siblings('li').removeClass('active');
            $(this).parent().siblings('ul').children().hide();
            $(this).parent().siblings('ul').children().eq(index).show();
        });

        $(".map-show-ways li").click(function() {
            $(this).addClass('current').siblings().removeClass('current');
        });


    });

    $(function () {
        // 获取Map实例
        var busMonitorMap = baiduMapUtil.getDisplayMap("busMonitorMap");
        busMonitorMap.setMapStyle({styleJson:baiduMapStyle});
        //加上下面那句才不报错
        busMonitorMap.centerAndZoom(new BMap.Point(113.3405,23.137428), 14);

        /*#######################################*/

        /*显示bus开始*/
        var markerClusterer;
        //信息窗体
        var infoBox;
        var displayGpsPos = function (data) {
            var baiduPoints =[];
//            alert(JSON.stringify(data));
            var posIconOnLine = new BMap.Icon(
                basePath+'/static/busAnalysisDisplay/images/bus_online.png',
//                '/busAnalysisSys/static/busAnalysisDisplay/images/station_normal.png',
                new BMap.Size(40,20)
            );
            var posIconOffLine = new BMap.Icon(
                basePath+'/static/busAnalysisDisplay/images/bus_offline.png',
//                '/busAnalysisSys/static/busAnalysisDisplay/images/station_normal.png',
                new BMap.Size(40,20)
            );
            var markerOptions = [];
//            {icon:posIcon,rotation:0};
//            alert($.mapUtils.gps84_To_bd09(113.376785,23.164345));
            $.each(data,function (index,item) {
//                var baiduPoint = $.mapUtils.gps84_To_bd09(item.lng,item.lat);
//                baiduPoints.push(new BMap.Point(baiduPoint[0], baiduPoint[1]));
                baiduPoints.push(new BMap.Point(item.lngBd, item.latBd));
                //10分钟
                var time = 10*60*1000;
                if (Date.parse(new Date()) -  Date.parse(new Date(item.gpsTime)) > time){
                    markerOptions.push({icon:posIconOffLine,rotation:0});
//                    console.log(item.equipNo);
//                    markerOptions.push({icon:posIconOffLine,rotation:(item.angle-90)});
                }else{
                    markerOptions.push({icon:posIconOnLine,rotation:0});
//                    markerOptions.push({icon:posIconOnLine,rotation:(item.angle-90)});
                }
            });
//            var baiduPoints = [
//                new BMap.Point(113.45667305396,23.398978084108),
//                new BMap.Point(113.4765825928,23.421942833634),
//                new BMap.Point(113.49320089908,23.410611758707),
//                new BMap.Point(113.49421220801,23.403646707442),
//                new BMap.Point(113.49793990841,23.393105408397)
//            ];


//            var MAX = 15000;
//            var pt = null;
//            var i = 0;
//            for (; i < MAX; i++) {
//                pt = new BMap.Point(Math.random() * 40 + 85, Math.random() * 30 + 21);
//                baiduPoints.push(pt);
//            }


//            var labels = [];
//            var labelOptions = [];

//            $.each(data,function (index,item) {
////                alert(JSON.stringify(item));
////                var item = JSON.parse(item);
//                var point = new BMap.Point(item.bdLng,item.bdLat);
//                baiduPoints.push(point);
//                labels.push(item.equipNo);
//                markerOptions.push({icon:posIcon,rotation:0});
//                labelOptions.push({offset:new BMap.Size(35,-30),position:point});
//
//            });
//            $.each(baiduPoints,function (index,item) {
//                markerOptions.push({icon:posIcon,rotation:0});
//            });
            console.log('坐标个数：'+baiduPoints.length);
            if (!ticc.isNull(markerClusterer)){
                markerClusterer.clearMarkers();
            }
//            baiduMapUtil.addMarker(baiduPoints,markerOptions);
            //最简单的用法，生成一个marker数组，然后调用markerClusterer类即可。
//            var markerClusterer = new BMapLib.MarkerClusterer(alarmMsgMap, {markers:markers});

//            markerClusterer = baiduMapUtil.addMarkerClusterer(baiduPoints,markerOptions,'click',function (marker) {
            markerClusterer = baiduMapUtil.addMarkerClusterer(baiduPoints,markerOptions,'click',function (marker) {
                displayInfoBox(marker.data);
                //显示客流变量变化曲线图
//                dispalyPassengerFlowChangChart();
//            <div class="online-car-msg ">
//                    <div>粤A123456    24.32km/h</div>
//                <div>532路（上行） | 一汽一公司 | 邓某某</div>
//                <div>当前站点：体育中心站</div>
//                <div>当前刷卡量：4852人次</div>
//                <em></em>
//                </div>

//                var d = marker.data;
//
//                var posi = marker.getPosition();
//                var htmlContent = "设备编号:<strong>"+d.equipNo+"</strong>";
//                baiduMapUtil.openInfoWindow(htmlContent,posi);
            },null,null,null,data);
        };
        /*显示bus结束*/

        /*#######################################*/

        //显示自定义信息窗体开始
        var displayInfoBox = function (data) {
            var path = basePath+'/redis/getBusFlow';
            var date = new Date().format("yyyyMMdd");
            var param = {'key':date+'-'+data.busNo};
            ticc.ajaxRequest(path,param,function (result) {
                if(result.status){
                    if (!ticc.isNullOrEmpty(result.data)){


                        var markerData = data;
                        var direction = '未知';
                        if (markerData.direction == '0'){
                            direction = '上行';
                        }else if (markerData.direction == '1'){
                            direction = '下行';
                        }
                        var html = '<div class="online-car-msg">';
                        html += '<div>'+markerData.busPlate+'    '+parseFloat(markerData.speed).toFixed(2)+'km/h</div>';
                        html += '<div>'+markerData.lineName+'（'+direction+'） | '+markerData.organName+' | '+markerData.driver+'</div>';
                        html += '<div>当前站点：'+markerData.stopName+'</div>';
                        html += '<div>当前刷卡量：'+result.data.busFlow+'人次</div>';
                        html += '<em></em></div>';


                        //如果infoBox不为空要关闭
                        if (!ticc.isNull(infoBox)){
                            infoBox.close();
                            infoBox = null;
                        }
                        infoBox = baiduMapUtil.createInfoBox(html,new BMap.Size(0, 20));
//                infoBox.open(marker.getPosition());
//            infoBox.open(marker);
//                        var baiduPoint = $.mapUtils.gps84_To_bd09(markerData.lng,markerData.lat);
//                        var posi = new BMap.Point(baiduPoint[0], baiduPoint[1]);
                        var posi = new BMap.Point(markerData.lngBd,markerData.latBd);
                        infoBox.open(posi);
                        //防止默认的关闭按钮图片404
                        $('div.infoBox>img').prop('src','').css('display','none');
//                $('div.infoBox>img').css('display','none');
                        $('div.online-car-msg>em').on("click",function () {
                            infoBox.close();
                        })

                    }else{
                        ticc.alertInfo(result.msg);
                    }
                }else{
                    ticc.alertError(result.msg);
                }
            });

        };
        //显示自定义信息窗体结束

        /*#######################################*/

        //全部gps位置
        var gpsData;
        /*请求全部gps实时位置开始*/
        var requestAllGpsStation = function () {
            var path = basePath+'/redis/getGpsPosition';
            var param = null;
            ticc.ajaxRequest(path,param,function (result) {
                if(result.status){
                    displayGpsPos(result.data);
                    gpsData = result.data;
                }else{
                    ticc.alertError(result.msg);
                }
            });
        };
        requestAllGpsStation();
        /*请求gps实时位置结束*/

        /*#######################################*/


        /*#######################################*/

        /*车辆编号搜索框开始*/
        var busNoSearch = function () {
//            var gpsData = [{equipNo:'1'},{equipNo:'2'},{equipNo:'1'},{equipNo:'2'},{equipNo:'1'},{equipNo:'2'},{equipNo:'1'},{equipNo:'2'}];
            var searchInput = $('#searchInput');
            //搜索框键盘释放的事件
            searchInput.on('keyup',function (e) {
                if (ticc.arrayIsNullOrEmpty(gpsData)){
                    return;
                }
                var $this = $(this);
                var last = e.timeStamp;

                //利用setTimeout解决keyup时间延迟问题
                setTimeout(function(){
                    if(last-e.timeStamp===0){
                        $('#searchHintArea').show();
                        var $searchHintTable = $('#searchHintTable tbody');
                        $searchHintTable.html('');

                        //是否没有匹配的数据
                        var isNoMatch = true;
                        var html;
                        var reg = new RegExp(searchInput.val().trim());
                        for(var i=0,len = gpsData.length;i<len;i++){
                            var item = gpsData[i];
//                            var equipNo = item.equipNo;
                            var busNo = item.busNo;
                            if(busNo.match(reg)){
                                html = "<tr><td>"+busNo+"</td></tr>";
                                $searchHintTable.append(html);
                                isNoMatch = false;
                            }
                        }
                        if (isNoMatch){
                            html = "<tr><td>未匹配到相关数据！</td></tr>";
                            $searchHintTable.append(html);
                        }
                    }
                },1000);
            });
            //搜索框hint选中事件
            //1.9+后的写法
            $('#searchHintTable tbody').on('click','tr',function () {
                //隐藏搜索框hint
                $('#searchHintArea').hide();
                var busNo = $(this).text().trim();
                if (!isNaN(busNo)){
                    //向搜索框赋值
                    searchInput.val(busNo);
                    requestBusGpsPositionByBusNo(busNo);
                }
            });
        };
        /*线路搜索框结束*/
        /*##############################################*/

        /*实现点击其他地方隐藏hint开始*/
        function stopPropagation(e) {
            if (e.stopPropagation)
                e.stopPropagation();
            else
                e.cancelBubble = true;
        }

        $(document).bind('click',function(){
            $('#searchHintArea').hide();
        });

        $('#searchHintArea').bind('click',function(e){
            stopPropagation(e);
        });
        $('#searchInput').bind('click',function(e){
            stopPropagation(e);
        });
        /*实现点击其他地方隐藏hint结束*/
        busNoSearch();
        /*##############################################*/


        /*根据车辆编号搜索车辆*/
        var requestBusGpsPositionByBusNo = function (busNo) {
            if(ticc.isNullOrEmpty(gpsData)){
                return;
            }
            $.each(gpsData,function (index,item) {
                if (busNo == item.busNo){
                    var baiduPoint = $.mapUtils.gps84_To_bd09(item.lng,item.lat);
                    var posi = new BMap.Point(baiduPoint[0], baiduPoint[1]);
                    busMonitorMap.centerAndZoom(posi, 19);
//                    busMonitorMap.setCenter(posi);
//                    busMonitorMap.setViewport([posi]);
//                    busMonitorMap.setViewport([posi]);
//                    busMonitorMap.setZoom(30);
//                    var htmlContent = "设备编号:<strong>"+equipNo+"</strong>";
//                    baiduMapUtil.openInfoWindow(htmlContent,posi);
                    displayInfoBox(item);

                }
            });

        };

        /*######################################*/
        var compare = function (obj1, obj2) {
            var val1 = obj2.counts;
            var val2 = obj1.counts;
            if (val1 < val2) {
                return -1;
            } else if (val1 > val2) {
                return 1;
            } else {
                return 0;
            }
        };
        //显示站点车辆在线排名前10开始
        var displayStationBusOnlineTop10 = function (data) {
            var busSum = data.busSum;
            $('#busSum').text(busSum);
            var onlinePercent = (data.terminalOnlineBusSum/data.busSum)*100;
            if (!ticc.isNumber(onlinePercent)){
                onlinePercent = 0;
            }
            var offlinePercent = (data.terminalOfflineBusSum/data.busSum)*100;
            if (!ticc.isNumber(offlinePercent)){
                offlinePercent = 0;
            }
            $('#terminalOnlineBusSum').text(data.terminalOnlineBusSum);
            $('#terminalOfflineBusSum').text(data.terminalOfflineBusSum);
            $('#terminalOnlineBusSumBar').css('width',onlinePercent+'%');
            $('#terminalOfflineBusSumBar').css('width',offlinePercent+'%');

            //先清空
            $('#stationBusOnlineTop10').empty();
            $.each(data.stationBusOnlineTop10Data.sort(compare),function (index,item) {
                var count = item.COUNTS;
                var percent = ((count / data.terminalOnlineBusSum) * 100).toFixed(2);
                if (!ticc.isNumber(percent)) {
                    percent = 0;
                }

                var html = '<li>' +
                    '            <span class="rank-num"><em>' + (index + 1) + '</em></span>' +
                    '            <div class="progress">' +
                    '                <div class="info">' +
                    '                <span class="name" title="' + item.STOPNAME + '">' + item.STOPNAME + '</span>' +
                    '                <span class="name-right">' + count + '辆 &nbsp; &nbsp;' + percent + '%</span>' +
                    '            </div>' +
                    '            <div class="progress-bar">' +
                    '                <div class="progress-inner" style="width: ' + percent + '%">' +
                    '                </div>' +
                    '                </div>' +
                    '                </div>' +
                    '                </li>';
                $('#stationBusOnlineTop10').append(html);
            });


        };
        //显示站点车辆在线排名前10结束

        /*######################################*/

        //显示线路车辆在线排名前10开始
        var displayLineBusOnlineTop10 = function (data) {
            $('#busSum').text(data.busSum);
            var onlinePercent = (data.terminalOnlineBusSum/data.busSum)*100;
            if (!ticc.isNumber(onlinePercent)){
                onlinePercent = 0;
            }
            var offlinePercent = (data.terminalOfflineBusSum/data.busSum)*100;
            if (!ticc.isNumber(offlinePercent)){
                offlinePercent = 0;
            }
            $('#terminalOnlineBusSum').text(data.terminalOnlineBusSum);
            $('#terminalOfflineBusSum').text(data.terminalOfflineBusSum);
            $('#terminalOnlineBusSumBar').css('width',onlinePercent+'%');
            $('#terminalOfflineBusSumBar').css('width',offlinePercent+'%');

            //先清空
            $('#lineBusOnlineTop10').empty();
            $.each(data.lineBusOnlineTop10Data.sort(compare),function (index,item) {
                var count = item.COUNTS;
                var percent = ((count / data.terminalOnlineBusSum) * 100).toFixed(2);
                if (!ticc.isNumber(percent)) {
                    percent = 0;
                }

                var html = '<li>' +
                    '            <span class="rank-num"><em>' + (index + 1) + '</em></span>' +
                    '            <div class="progress">' +
                    '                <div class="info">' +
                    '                <span class="name" title="' + item.LINENAME + '">' + item.LINENAME + '</span>' +
                    '                <span class="name-right">' + count + '辆 &nbsp; &nbsp;' + percent + '%</span>' +
                    '            </div>' +
                    '            <div class="progress-bar">' +
                    '                <div class="progress-inner" style="width: ' + percent + '%">' +
                    '                </div>' +
                    '                </div>' +
                    '                </div>' +
                    '                </li>';
                $('#lineBusOnlineTop10').append(html);
            });
        };
        //显示线路车辆在线排名前10结束

        /*######################################*/
        //请求站点车辆在线排名前10开始
        var requestStationBusOnlineTop10 = function () {
            var path = basePath+'/busStatus/findStaionBusOnlineTop10';
            var param = null;
            ticc.ajaxRequest(path,param,function (result) {
                if(result.status){
                    if (!ticc.isNullOrEmpty(result.data)){
                        displayStationBusOnlineTop10(result.data);
                    }else{
                        ticc.alertInfo(result.msg);
                    }
                }else{
                    ticc.alertError(result.msg);
                }
            });
        };
        requestStationBusOnlineTop10();
        //请求站点车辆在线排名前10结束

        /*######################################*/
        //请求线路车辆在线排名前10开始
        var requestLineBusOnlineTop10 = function () {
            var path = basePath+'/busStatus/findLineBusOnlineTop10';
            var param = null;
            ticc.ajaxRequest(path,param,function (result) {
                if(result.status){
                    if (!ticc.isNullOrEmpty(result.data)){
                        displayLineBusOnlineTop10(result.data);
                    }else{
                        ticc.alertInfo(result.msg);
                    }
                }else{
                    ticc.alertError(result.msg);
                }
            });
        };
        //请求线路车辆在线排名前10结束

        /*##############################################*/
        //右边站点线路切换开始

        $(".top-ul li").click(function() {
            $(this).addClass('active').siblings().removeClass('active');
            if ($(this).index() == 0){
                //站点
                requestStationBusOnlineTop10();
            }else {
                //线路
                requestLineBusOnlineTop10();
            }
        });

        //右边站点线路切换结束
        /*##############################################*/

        //定时请求车辆在线数前10  --每15分钟
        setInterval(function () {
            $(".top-ul li").each(function (index,item) {
                if (!$(this).hasClass('active')){
                    return true;//continute
                }
                if (index == 0){
                    displayStationBusOnlineTop10();
                    return false; //break
                }else {
                    requestLineBusOnlineTop10();
                    return false;
                }
            });
        },1000*60*15);

        /*#######################################*/


        //定时请求车辆gps定位  --每15秒
        setInterval(function () {
            requestAllGpsStation();
        },1000*15);

        /*#######################################*/
    });

</script>
</html>