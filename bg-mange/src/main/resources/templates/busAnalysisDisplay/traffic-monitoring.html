<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,height=device-height, minimum-scale=1.0, maximum-scale=1.0">
    <title>客流监控</title>
    <link rel="stylesheet" type="text/css" th:href="@{/static/busAnalysisDisplay/css/style.css}" />
    <link rel="stylesheet" th:href="@{/static/jeasyui/themes/cyan/easyui.css}" type="text/css"/>
    <link rel="stylesheet" th:href="@{/static/jeasyui/themes/color.css}" type="text/css" />
    <link rel="stylesheet" th:href="@{/static/jeasyui/themes/icon.css}" type="text/css" />
    <script  th:src="@{/static/busAnalysisDisplay/js/jquery-1.11.1.min.js}"></script>
    <script type="text/javascript">
        (function(){
            function sizeHtml(){
                window.mtSizeBase = $(window).width()/32;
                //window.mtSizeBase = window.mtSizeBase>45?45:window.mtSizeBase;
                $("html").css("font-size",window.mtSizeBase+"px");
            }
            sizeHtml();
            $(window).resize(function(){
                setTimeout(function(){
                    sizeHtml();
                },300);
            });
        })();

    </script>
</head>
<body class="common-bg" style="overflow:hidden;">
<h3 class="head-img"></h3>
<div class="content-body">
    <div class="nav-crosswise">
        <div class="nav-crosswise-main c-fff"><span>当前位置</span>><span>地图展示</span>><span>客流监控</span></div>
    </div>
    <div class="main-area clearfix">
        <div class="lengthways-nav fl" id="side-menu">
            <div class="map-show-nav selected">
                <ul>
                    <li class="active">
                        <span class="J_menuItem"><img th:src="@{/static/busAnalysisDisplay/images/quan.png}">地图展示</span>
                        <ul>
                            <li><a href="javascript:;" class="on" >客流监控</a></li>
                            <li><a href="car-monitoring.html" th:href="@{/page/busMonitor}">车辆监控</a></li>
                            <li><a href="car-transfer.html" th:href="@{/page/busTransform}">车辆换乘</a></li>
                            <li><a href="od-fenbu.html" th:href="@{/page/regionODDistri}">区域OD分布</a></li>
                            <li><a href="alarm-msg.html" th:href="@{/page/alarmMsg}" >报警信息</a></li>
                        </ul>
                    </li>
                    <li >
                        <span class="J_menuItem"><img th:src="@{/static/busAnalysisDisplay/images/quan.png}">数据分析</span>
                        <ul>
                            <li>
                                <span class="J_menuItem">公交客运</span>
                                <ul>
                                    <li><a href="passenger-form.html" th:href="@{/page/passenVolumeCons}">客运量构成</a></li>
                                    <li><a href="brush-card-number.html" th:href="@{/page/swingCardVolumeStati}">刷卡量统计</a></li>
                                </ul>
                            </li>
                            <li>
                                <span class="J_menuItem">公交运行</span>
                                <ul>
                                    <li><a href="gaofeng-chart.html" th:href="@{/page/peakRun}">高峰运行图</a></li>
                                    <li><a href="running-speed-chart.html" th:href="@{/page/runSpeedStati}">运行速度统计</a></li>
                                    <li><a href="traffic-zhishu.html" th:href="@{/page/trafficNum}">交通指数</a></li>
                                    <li><a href="traffic-routes.html" th:href="@{/page/congestionRoad}">拥堵路段</a></li>
                                </ul>
                            </li>
                            <li>
                                <span class="J_menuItem">换乘分析</span>
                                <ul>
                                    <li><a href="transfer-form.html" th:href="@{/page/transChangeCons}">换乘量构成</a></li>
                                    <li><a href="transfer-tongji.html" th:href="@{/page/transChangeStati}">换乘量统计</a></li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>

        </div>
        <div class="map-area fr " id="content">

            <!--<div class="keliu-form ">
                <div>站点名：体育中心站</div>
                <div class="p-bottom">4月23日客流量变化表</div>
                <div class="keliu-form-con">
                </div>
                <div class="p-top">当前客流量：4852人次</div>
                <em></em>
                <span class="down-arrow"></span>
            </div>-->

            <!--#######################################-->

            <!--地图开始-->
            <div id="passengerFlowMonitorMap" class="mapStyle">
            </div>
            <!--地图结束-->
            <!--线路地图开始-->
            <div id="linePassengerFlowMonitorMap" class="mapStyle" style="display: none">
            </div>
            <!--线路地图结束-->
            <!--brt地图开始-->
            <div id="brtPassengerFlowMonitorMap" class="mapStyle" style="display: none">
            </div>
            <!--brt地图结束-->
            <!--<img th:src="@{/static/busAnalysisDisplay/images/map.jpg}" alt="" />-->
            <ol class="map-show-ways">
                <li class="current bbox">站点</li>
                <li class="bbox">线路</li>
                <li class="bbox">BRT</li>
            </ol>

            <div class="rank-pup" id="pup">
                <h4 class="num" id="passengerFlowSum">0</h4>
                <p class="title">今日客流量总数（万次）</p>
                <div class="search" style="position: relative">
                    <input id="searchInput" type="search" name="" placeholder="站点名/线路名称" />
                    <!--搜索框模糊查询hint开始-->
                    <div id="searchHintArea" style="display: none">
                        <section>
                            <table id="searchHintTable">
                                <tbody>
                                </tbody>
                            </table>
                        </section>
                    </div>
                    <!--搜索框模糊查询hint结束-->
                </div>
                <div class="rank-title">客流量排名 TOP10</div>
                <ul class="top-ul">
                    <li  class="active"><span>站点</span></li>
                    <li><span>线路</span></li>
                </ul>
                <ul class="rank-data">
                    <li>
                        <ul class="progress-wrap" id="stationTop10">
                            <li>
                                <span class="rank-num"><em>1</em></span>
                                <div class="progress">
                                    <div class="info">
                                        <span class="name" title="珠江新城站">珠江新城站</span>
                                        <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-inner">
                                            <!-- <div class="progress-inner"></div> -->
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <span class="rank-num"><em>2</em></span>
                                <div class="progress">
                                    <div class="info">
                                        <span class="name" title="珠江新城站">珠江新城站</span>
                                        <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-inner">
                                            <!-- <div class="progress-inner"></div> -->
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <span class="rank-num"><em>3</em></span>
                                <div class="progress">
                                    <div class="info">
                                        <span class="name" title="珠江新城站">珠江新城站</span>
                                        <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-inner">
                                            <!-- <div class="progress-inner"></div> -->
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <span class="rank-num"><em>4</em></span>
                                <div class="progress">
                                    <div class="info">
                                        <span class="name" title="珠江新城站">珠江新城站</span>
                                        <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-inner">
                                            <!-- <div class="progress-inner"></div> -->
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <span class="rank-num"><em>5</em></span>
                                <div class="progress">
                                    <div class="info">
                                        <span class="name" title="珠江新城站">珠江新城站</span>
                                        <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-inner">
                                            <!-- <div class="progress-inner"></div> -->
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <span class="rank-num"><em>6</em></span>
                                <div class="progress">
                                    <div class="info">
                                        <span class="name" title="珠江新城站">珠江新城站</span>
                                        <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-inner">
                                            <!-- <div class="progress-inner"></div> -->
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <span class="rank-num"><em>7</em></span>
                                <div class="progress">
                                    <div class="info">
                                        <span class="name" title="珠江新城站">珠江新城站</span>
                                        <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-inner">
                                            <!-- <div class="progress-inner"></div> -->
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <span class="rank-num"><em>8</em></span>
                                <div class="progress">
                                    <div class="info">
                                        <span class="name" title="珠江新城站">珠江新城站</span>
                                        <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-inner">
                                            <!-- <div class="progress-inner"></div> -->
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <span class="rank-num"><em>9</em></span>
                                <div class="progress">
                                    <div class="info">
                                        <span class="name" title="珠江新城站">珠江新城站</span>
                                        <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-inner">
                                            <!-- <div class="progress-inner"></div> -->
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <span class="rank-num"><em>10</em></span>
                                <div class="progress">
                                    <div class="info">
                                        <span class="name" title="珠江新城站">珠江新城站</span>
                                        <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-inner">
                                            <!-- <div class="progress-inner"></div> -->
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <ul class="progress-wrap" id="lineTop10">
                            <li>
                                <span class="rank-num"><em>1</em></span>
                                <div class="progress">
                                    <div class="info">
                                        <span class="name" title="珠江新城线">珠江新城线</span>
                                        <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-inner">
                                            <!-- <div class="progress-inner"></div> -->
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <span class="rank-num"><em>2</em></span>
                                <div class="progress">
                                    <div class="info">
                                        <span class="name" title="珠江新城线">珠江新城线</span>
                                        <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-inner">
                                            <!-- <div class="progress-inner"></div> -->
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <span class="rank-num"><em>3</em></span>
                                <div class="progress">
                                    <div class="info">
                                        <span class="name" title="珠江新城线">珠江新城线</span>
                                        <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-inner">
                                            <!-- <div class="progress-inner"></div> -->
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <span class="rank-num"><em>4</em></span>
                                <div class="progress">
                                    <div class="info">
                                        <span class="name" title="珠江新城线">珠江新城线</span>
                                        <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-inner">
                                            <!-- <div class="progress-inner"></div> -->
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <span class="rank-num"><em>5</em></span>
                                <div class="progress">
                                    <div class="info">
                                        <span class="name" title="珠江新城线">珠江新城线</span>
                                        <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-inner">
                                            <!-- <div class="progress-inner"></div> -->
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <span class="rank-num"><em>6</em></span>
                                <div class="progress">
                                    <div class="info">
                                        <span class="name" title="珠江新城线">珠江新城线</span>
                                        <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-inner">
                                            <!-- <div class="progress-inner"></div> -->
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <span class="rank-num"><em>7</em></span>
                                <div class="progress">
                                    <div class="info">
                                        <span class="name" title="珠江新城线">珠江新城线</span>
                                        <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-inner">
                                            <!-- <div class="progress-inner"></div> -->
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <span class="rank-num"><em>8</em></span>
                                <div class="progress">
                                    <div class="info">
                                        <span class="name" title="珠江新城线">珠江新城线</span>
                                        <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-inner">
                                            <!-- <div class="progress-inner"></div> -->
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <span class="rank-num"><em>9</em></span>
                                <div class="progress">
                                    <div class="info">
                                        <span class="name" title="珠江新城线">珠江新城线</span>
                                        <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-inner">
                                            <!-- <div class="progress-inner"></div> -->
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <span class="rank-num"><em>10</em></span>
                                <div class="progress">
                                    <div class="info">
                                        <span class="name" title="珠江新城线">珠江新城线</span>
                                        <span class="name-right">751次 &nbsp; &nbsp;18.2%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-inner">
                                            <!-- <div class="progress-inner"></div> -->
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </li>
                </ul>

            </div>
        </div>
    </div>
</div>

</body>
<script type="text/javascript" th:replace="common/fragment :: commonVar"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=fdv5gclnF2HSnNyKm4Dj3aVuLUGMLUZ1" ></script>
<script type="text/javascript" src="http://api.map.baidu.com/library/InfoBox/1.2/src/InfoBox_min.js" ></script>
<!--<script type="text/javascript" src="http://api.map.baidu.com/library/TextIconOverlay/1.2/src/TextIconOverlay_min.js" ></script>-->
<!--<script type="text/javascript" src="http://api.map.baidu.com/library/MarkerClusterer/1.2/src/MarkerClusterer_min.js"></script>-->
<script type="text/javascript" th:src="@{/static/js/baiduMap/TextIconOverlay_min.js}"></script>
<script type="text/javascript" th:src="@{/static/js/baiduMap/MarkerClusterer_min.js}"></script>
<script type="text/javascript" th:src="@{/static/busAnalysisDisplay/js/baiduMapStyle.js}"></script>
<script type="text/javascript" th:src="@{/static/jeasyui/jquery.easyui.min.js}"></script>
<script type="text/javascript" th:src="@{/static/jeasyui/locale/easyui-lang-zh_CN.js}"></script>
<script type="text/javascript" th:src="@{/static/js/echarts/echarts.min.js}"></script>
<script type="text/javascript" th:src="@{/static/js/prototypeExpand.js}"></script>
<script type="text/javascript" th:src="@{/static/js/baiduMapCommon.js}"></script>
<script  th:src="@{/static/busAnalysisDisplay/js/jqueryExtend.js}"></script>
<script type="text/javascript" th:src="@{/static/js/ticcCommon.js}"></script>
<script type="text/javascript" th:src="@{/static/js/echarts/map/bmap.js}"></script>
<!--<script type="text/javascript" th:src="@{/static/busAnalysisDisplay/js/guangz-traffic.js}"></script>-->
<script type="text/javascript" th:src="@{/static/busAnalysisDisplay/js/lineDetails.js}"></script>
<script type="text/javascript">
    //下面是页面的
    $(function(){
        var body = (document.compatMode && document.compatMode.toLowerCase() == "css1compat") ? document.documentElement : document.body;

        function ResizeTable() {
            var sideWidth = document.getElementById("side-menu");
            var con = document.getElementById('content');
            var pup = document.getElementById('pup');
            var pupH = pup.clientHeight;

            sideWidth.style.height = '' + Math.max((body.clientHeight - 100), 0) + "px";
            con.style.height = '' + Math.max((body.clientHeight - 100), 0) + "px";
            con.style.width = '' + Math.max((body.clientWidth - 180), 0) + "px";
            pup.style.top = '' + Math.max((body.clientHeight - pupH)/2, 0) + "px";


            var pro = Math.max((con.clientHeight - 100-300), 0) + "px";
            $(".progress-wrap").css("height",pro)
        }
        ResizeTable();

        $(window).resize(function () {
            ResizeTable()
        });

        var $item = $(".J_menuItem");
        $item.on("click",function(){
            var $this = $(this);
            $this.siblings("ul").slideToggle(300);
            $this.parent("li").siblings("li").find("ul").slideUp(300);
            $this.parent("li").addClass("active").siblings("li").removeClass("active");
        })


        $(".top-ul li").click(function() {
            var index = $(this).index();
            $(this).addClass('active').siblings('li').removeClass('active');
            $(this).parent().siblings('ul').children().hide();
            $(this).parent().siblings('ul').children().eq(index).show();
        });

//        $(".map-show-ways li").click(function() {
//            $(this).addClass('current').siblings().removeClass('current');
//        });


    });

    $(function () {
        // 获取Map实例
        var passengerFlowMonitorMap;
        var brtPassengerFlowMonitorMap;

        var initMap = function () {
            passengerFlowMonitorMap = baiduMapUtil.getDisplayMap("passengerFlowMonitorMap");
            passengerFlowMonitorMap.setMapStyle({styleJson:baiduMapStyle});
            //加上下面那句才不报错
            passengerFlowMonitorMap.centerAndZoom(new BMap.Point(113.3405,23.137428), 14);
        };
        var brtInitMap = function () {
            brtPassengerFlowMonitorMap = baiduMapUtil.getDisplayMap("brtPassengerFlowMonitorMap");
            brtPassengerFlowMonitorMap.setMapStyle({styleJson:baiduMapStyle});
            //加上下面那句才不报错
            setTimeout(function () {
                brtPassengerFlowMonitorMap.centerAndZoom(new BMap.Point(113.37235,23.138335), 14);
            },1500);
            baiduMapUtil.setMap(brtPassengerFlowMonitorMap);
        };
        initMap();
        /*#######################################*/

        /*显示站点开始*/
        var markerClusterer;
        //信息窗体
        var infoBox;
        var displayStation = function (data) {
            var baiduPoints =[];
//            alert(JSON.stringify(data));
            $.each(data,function (index,item) {
                baiduPoints.push(new BMap.Point(item.longitudeBd, item.latitudeBd));
//                var baiduPoint = $.mapUtils.gps84_To_bd09(item.longitude,item.latitude);
//                baiduPoints.push(new BMap.Point(baiduPoint[0], baiduPoint[1]));
            });
//            var baiduPoints = [
//                new BMap.Point(113.45667305396,23.398978084108),
//                new BMap.Point(113.4765825928,23.421942833634),
//                new BMap.Point(113.49320089908,23.410611758707),
//                new BMap.Point(113.49421220801,23.403646707442),
//                new BMap.Point(113.49793990841,23.393105408397)
//            ];


//            var MAX = 15000;
//            var pt = null;
//            var i = 0;
//            for (; i < MAX; i++) {
//                pt = new BMap.Point(Math.random() * 40 + 85, Math.random() * 30 + 21);
//                baiduPoints.push(pt);
//            }


//            var labels = [];
//            var labelOptions = [];
            var posIcon = new BMap.Icon(
                basePath+'/static/busAnalysisDisplay/images/station_normal.png',
//                '/busAnalysisSys/static/busAnalysisDisplay/images/station_normal.png',
                new BMap.Size(20,40)
            );
            var markerOptions = {icon:posIcon,rotation:0};
//            $.each(data,function (index,item) {
////                alert(JSON.stringify(item));
////                var item = JSON.parse(item);
//                var point = new BMap.Point(item.bdLng,item.bdLat);
//                baiduPoints.push(point);
//                labels.push(item.equipNo);
//                markerOptions.push({icon:posIcon,rotation:0});
//                labelOptions.push({offset:new BMap.Size(35,-30),position:point});
//
//            });
//            $.each(baiduPoints,function (index,item) {
//                markerOptions.push({icon:posIcon,rotation:0});
//            });
            console.log('坐标个数：'+baiduPoints.length);
            if (!ticc.isNull(markerClusterer)){
                markerClusterer.clearMarkers();
            }
//            baiduMapUtil.addMarker(baiduPoints,markerOptions);
            //最简单的用法，生成一个marker数组，然后调用markerClusterer类即可。
//            var markerClusterer = new BMapLib.MarkerClusterer(alarmMsgMap, {markers:markers});

//            markerClusterer = baiduMapUtil.addMarkerClusterer(baiduPoints,markerOptions,'click',function (marker) {
            markerClusterer = baiduMapUtil.addMarkerClusterer(baiduPoints,markerOptions,'click',function (marker) {
                var markerData = marker.data;
                //获取站点客流量和站点客流量小时变化
                var path = basePath+'/redis/getStationFlowHourChange';
                var date=new Date();
                var month=date.getMonth()+1;
                var day=date.getDate();
                var key = (date.format('yyyyMMdd'))+'-'+markerData.busStopCode+'-'+markerData.upDown;
                var param = {'key':key};
                ticc.ajaxRequest(path,param,function (result) {
//                alert(JSON.stringify(result))
                    if(result.status){
                        if (!ticc.isNullOrEmpty(result.data)){



//                alert(JSON.stringify(markerData));
//                var html = '<div class="online-car-msg" style="width: 400px;height: 300px"><em></em></div>';
                            var html = '<div class="keliu-form"><div>站点名：'+markerData.busStopName+'('+markerData.bsDirection+')</div>';
                            html += '<div class="p-bottom">'+month+'月'+day+'日客流量变化表</div>';
                            html += '<div class="keliu-form-con" style="position: relative"><div id="passengerFlowChangChart" class="chartStyle"></div></div>';
                            html += '<div class="p-top">当前客流量：'+result.data.stationCurrentFlow+'人次</div>';
                            html += '<em></em>';
                            html += '<span class="down-arrow"></span></div>';

                            //如果infoBox不为空要关闭
                            if (!ticc.isNull(infoBox)){
                                infoBox.close();
                                infoBox = null;
                            }
                            infoBox = baiduMapUtil.createInfoBox(html);
//                infoBox.open(marker.getPosition());
                            infoBox.open(marker);
//                infoBox.setPosition(marker.getPosition());
                            //防止默认的关闭按钮图片404
                            $('div.infoBox>img').prop('src','').css('display','none');
//                $('div.infoBox>img').css('display','none');
                            $('div.keliu-form>em').on("click",function () {
                                infoBox.close();
                            });

                            //显示客流变量变化曲线图
                            dispalyPassengerFlowChangChart(result.data.hoursFlowChangeDataMap);
//            <div class="online-car-msg ">
//                    <div>粤A123456    24.32km/h</div>
//                <div>532路（上行） | 一汽一公司 | 邓某某</div>
//                <div>当前站点：体育中心站</div>
//                <div>当前刷卡量：4852人次</div>
//                <em></em>
//                </div>

//                var d = marker.data;
//
//                var posi = marker.getPosition();
//                var htmlContent = "设备编号:<strong>"+d.equipNo+"</strong>";
//                baiduMapUtil.openInfoWindow(htmlContent,posi);


                        }else{
                            ticc.alertInfo(result.msg);
                        }
                    }else{
                        ticc.alertError(result.msg);
                    }
                });

            },null,null,null,data);
        };
        /*显示站点结束*/

        /*#######################################*/

        /*请求全部站点开始*/
        var requestAllStation = function () {
            var path = basePath+'/stationLine/getDuplicateRemovalStationLine';
            var param = null;
            ticc.ajaxRequest(path,param,function (result) {
                if(result.status){
                    displayStation(result.data);
                }else{
                    ticc.alertError(result.msg);
                }
            });
        };
        requestAllStation();
        /*请求全部站点结束*/

        /*#######################################*/

        var compare = function (obj1, obj2) {
            var val1 = obj1.name;
            var val2 = obj2.name;
            if (val1 < val2) {
                return -1;
            } else if (val1 > val2) {
                return 1;
            } else {
                return 0;
            }
        };
        /*客流变化曲线图开始*/
        var dispalyPassengerFlowChangChart = function (data) {
            // 基于准备好的dom，初始化echarts实例
            var passengerFlowChangChart = echarts.init(document.getElementById('passengerFlowChangChart'));
            // 指定图表的配置项和数据
            /*        var option = {
                        title: {
                            text: 'ECharts 入门示例'
                        },
                        tooltip: {},
                        legend: {
                            data:['销量']
                        },
                        xAxis: {
                            data: ["衬衫","羊毛衫","雪纺衫","裤子","高跟鞋","袜子"]
                        },
                        yAxis: {},
                        series: [{
                            name: '销量',
                            type: 'bar',
                            data: [5, 20, 36, 10, 10, 20]
                        }]
                    };*/



            // var color = '#075480';
            var splitLineColor = '#075480';
            var color = '#FFFFFF';
            var lineColor = '#0a324b';
            var xAxisData = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12','13','14','15','16',
                '17','18','19','20','21','22','23','24'];
            // var seriesData = [45, 55, 70, 95, 55, 70, 85];
            var scale = 1;

            var flowChange = $.map(data,function (value,key) {
                return{
                    name: key,
                    value: value
                }
            });

            var echartData = {
                data1: flowChange.sort(compare)
            };
            var maxData = '55%';
            //线的item样式
            var lineItemStyle = {
                normal: {
                    lineStyle:{
                        width:1
                    }
                }
            };

            var option = {
                tooltip: {
                    show: true, //去除面板显示
                    trigger: 'axis',
                    axisPointer: {
                        /*                    'line' 直线指示器
                                            'shadow' 阴影指示器
                                            'cross' 十字准星指示器。其实是种简写，表示启用两个正交的轴的 axisPointer。*/
                        type: 'shadow',
                        label: {
                            backgroundColor: '#185164'
                        }
                    }
                },
                legend: {//图例组件
                    show: false,
                    right:40,
                    bottom:10,
                    itemGap:10,
                    data: ['2017年', '2018年','2016年'],
                    icon: 'roundRect',
                    itemWidth:20,
                    itemHeight:9,
                    textStyle: {
                        color: '#ffffff',
                        // fontSize:16*scale,
                        fontSize:14*scale,
                        // height:50,
                        // padding: [0, 0, 600, 0]
                    },
                },
                backgroundColor: '#000103',
                // color: ['#295beb', '#eb297d','#ffc72b'], //3dd3f8
                color: ['#12A1AB'], //3dd3f8
                grid: {//直角坐标系内绘图网格
                    left: '3%',
                    right: '10%',
                    top:'15%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    axisLabel: {
                        textStyle: {
                            color: color,
                            fontSize: 12*scale
                        },
                        // rich: {
                        //     x: {
                        //         fontSize: 18,
                        //         fontFamily: 'Microsoft YaHei',
                        //         borderColor: '#449933',
                        //         borderRadius: 4
                        //     }
                        // }
                    },
                    axisLine: {
                        lineStyle: {
                            color: lineColor
                        }
                    },
                    // splitLine: {
                    //     show: true,
                    //     lineStyle:{
                    //         color: lineColor
                    //     }
                    // },
                    // name: '月',
                    nameTextStyle: {
                        color: color,
                        fontSize: 12*scale,
                        padding: [0, 0, 0, 10]
                    },
                    data: xAxisData
                },
                yAxis: {
                    type: 'value',
//                    max: 100,
                    axisLabel: {
                        padding: [0, 15, 0, 0],
                        textStyle: {
                            color: color,
                            fontSize: 12*scale
                        }
                    },
                    axisLine: {
                        lineStyle: {
                            color: lineColor
                        }
                    },
                    splitLine: {
                        show: true,
                        lineStyle:{
                            color: lineColor
                        }
                    },
                    // splitLine: {
                    //     show: false
                    // },
                    name: '人',
                    nameTextStyle: {
                        color: color,
                        fontSize: 12*scale,
                        // padding: [0, 0, -25, 0]
//                        padding: [0, 60, -220, 0]//表示 [上, 右, 下, 左] 的边距。
                    }
                },
                dataZoom: [{
                    show: true,
                    height: 20,
                    xAxisIndex: [
                        0
                    ],
                    bottom: 0,
                    start: 10,
                    end: 80,
                    handleIcon: 'path://M306.1,413c0,2.2-1.8,4-4,4h-59.8c-2.2,0-4-1.8-4-4V200.8c0-2.2,1.8-4,4-4h59.8c2.2,0,4,1.8,4,4V413z',
                    handleSize: '110%',
                    handleStyle:{
                        // color:"#d3dee5"
                        color:"#0C489C"
                    },
                    textStyle:{
                        color:"#fff"},
                    borderColor:"#0F1A32"
                }, {
                    type: "inside",
                    show: true,
                    height: 15,
                    start: 1,
                    end: 35
                }],
                series: [{
                    name: '客流量',
                    type: 'line',
                    stack: '总量',
                    smooth: true, //这句就是让曲线变平滑的
                    data: echartData.data1,
                    symbol: 'none', //拐点样式
                    itemStyle: lineItemStyle,
                    areaStyle: {
                        normal: {
                            // color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                            //     offset: 0,
                            //     color: 'rgba(137, 189, 27, 0.3)'
                            // }, {
                            //     offset: 0.8,
                            //     color: 'rgba(137, 189, 27, 0)'
                            // }], false),
                            color: 'rgba(38,93,110, 0.5)',
                            // shadowColor: 'rgba(0, 0, 0, 0.1)',
                            // shadowBlur: 10
                        }
                    },
                    markPoint: {
                        data: [
                            {
                                symbol:'circle',
                                type: 'max',
                                symbolSize: [5, 5],
                                itemStyle: {
                                    normal: {
                                        color: "#FF9E0C",
                                        borderColor:'rgba(255,157,11, 0.3)',//rgba(255, 199, 43, .3)
                                        borderWidth:10*scale,
                                        shadowColor:'#FF9E0C',
                                        shadowBlur:30,
                                    }
                                },
                                label: {
                                    normal: {
                                        show: false
                                    }
                                }
                            }]
                    },
                    /*                lineStyle:{
                                        color:"#ffffff",
                                        width:10,
                                        type:'dotted'
                                    }*/

                }
                ]
            };



            // 使用刚指定的配置项和数据显示图表。
            passengerFlowChangChart.setOption(option);
        };
        /*客流变化曲线图结束*/

        /*##############################################*/

        var ac;
        /*站点搜索框开始*/
        var myValue;
        var stationSearch = function () {
            ac = new BMap.Autocomplete(    //建立一个自动完成的对象
                {
                    "input" : "searchInput"//输入框id
                    ,"location" : "广州市"//设定返回结果的所属范围
//                ,"location" : lineGotoAreaMap//设定返回结果的所属范围
                });
            ac.addEventListener("onconfirm", function(e) {    //鼠标点击下拉列表后的事件
                var _value = e.item.value;
                myValue = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
                console.log(myValue);
                setPlace();
            });
        };
        function setPlace(){
//            lineGotoAreaMap.clearOverlays();    //清除地图上所有覆盖物
            function myFun(){
//                ac.dispose();
                var pp = local.getResults().getPoi(0).point;    //获取第一个智能搜索的结果
                passengerFlowMonitorMap.centerAndZoom(pp, 20);
//                lineGotoAreaMap.addOverlay(new BMap.Marker(pp));    //添加标注
//                requestBaiDuPoint(pp);
            }
            var local = new BMap.LocalSearch(passengerFlowMonitorMap, { //智能搜索
                onSearchComplete: myFun
            });
            local.search(myValue);
        }
        stationSearch();
        /*站点搜索框结束*/


        /*#######################################*/

        /*线路搜索框开始*/
        var allLineNos;
        var lineNameSearch = function () {
//            var gpsData = [{equipNo:'1'},{equipNo:'2'},{equipNo:'1'},{equipNo:'2'},{equipNo:'1'},{equipNo:'2'},{equipNo:'1'},{equipNo:'2'}];
//            var traffic
//            var allLine = traffic;

            var path = basePath+'/redis/getAllLineNo';
            var param = null;
            ticc.ajaxRequest(path,param,function (result) {
//                alert(JSON.stringify(result))
                if (result.status) {
                    if (!ticc.isNullOrEmpty(result.data)) {
                        allLineNos = result.data;
                        var searchInput = $('#searchInput');
                        //搜索框键盘释放的事件
                        searchInput.on('keyup',function (e) {
                            if (ticc.arrayIsNullOrEmpty(allLine)){
                                return;
                            }
                            var $this = $(this);
                            var last = e.timeStamp;

                            //利用setTimeout解决keyup时间延迟问题
                            setTimeout(function(){
                                if(last-e.timeStamp===0){
                                    $('#searchHintArea').show();
                                    var $searchHintTable = $('#searchHintTable tbody');
                                    $searchHintTable.html('');

                                    //是否没有匹配的数据
                                    var isNoMatch = true;
                                    var html;
                                    var reg = new RegExp(searchInput.val().trim());
                                    for(var i=0,len = allLineNos.length;i<len;i++){
                                        var item = allLineNos[i];
                                        var lineNo = item.lineNo;
                                        if(lineNo.match(reg)){
                                            html = "<tr><td>"+lineNo+"</td></tr>";
                                            $searchHintTable.append(html);
                                            isNoMatch = false;
                                        }
                                    }
                                    if (isNoMatch){
                                        html = "<tr><td>未匹配到相关数据！</td></tr>";
                                        $searchHintTable.append(html);
                                    }
                                }
                            },1000);
                        });
                        //搜索框hint选中事件
                        //1.9+后的写法
                        $('#searchHintTable tbody').on('click','tr',function () {
                            //隐藏搜索框hint
                            $('#searchHintArea').hide();
                            var lineNo = $(this).text().trim();
                            //向搜索框赋值
                            searchInput.val(lineNo);
                            requestLineByLineNo(lineNo);
//                            if (!isNaN(lineNo)){
//                                //向搜索框赋值
//                                searchInput.val(lineNo);
//                                requestLineByLineNo(lineNo);
//                            }
                        });

                    } else {
                        ticc.alertInfo(result.msg);
                    }
                } else {
                    ticc.alertError(result.msg);
                }
            });

        };
        /*线路搜索框结束*/

        /*##############################################*/

        /*实现点击其他地方隐藏hint开始*/
        function stopPropagation(e) {
            if (e.stopPropagation)
                e.stopPropagation();
            else
                e.cancelBubble = true;
        }

        $(document).bind('click',function(){
            $('#searchHintArea').hide();
        });

        $('#searchHintArea').bind('click',function(e){
            stopPropagation(e);
        });
        $('#searchInput').bind('click',function(e){
            stopPropagation(e);
        });
        /*实现点击其他地方隐藏hint结束*/

        /*##############################################*/
        //右边站点线路切换开始

        $(".top-ul li").click(function() {
            $(this).addClass('active').siblings().removeClass('active');
            if ($(this).index() == 0){
                //站点
                rigtCurrentStation();

            }else {
                //线路
                rigtCurrentLine();
            }
        });

        //右边站点线路切换结束

        //右边站点线路切换选中站点开始
        var rigtCurrentStation = function () {
            $('#searchInput').unbind('keyup');
//            //搜索框键盘释放的事件
//            stationSearch();
            //请求站点前10
            requestStationTop10();
        };

        //右边站点线路切换选中站点结束

        //右边站点线路切换选中线路开始
        var rigtCurrentLine = function () {
//            if (!ticc.isNull(ac)){
//                ac.dispose();
//            }
//            lineNameSearch();
            //请求线路前10
            requestLineTop10();
        };

        //右边站点线路切换选中线路结束
        /*##############################################*/

        //左上角线路站点切换开始
        $(".map-show-ways li").click(function() {
            $(this).addClass('current').siblings().removeClass('current');
            switch ($(this).index()){
                case 0://站点
                    //站点
                    //销毁线路
                    if (!ticc.isNull(lineChart)){
                        lineChart.dispose();
                    }
                    //解绑搜索框键盘释放的事件
                    $('#searchInput').unbind('keyup');

                    $('#linePassengerFlowMonitorMap').hide();
                    $('#passengerFlowMonitorMap').show();
                    $('#brtPassengerFlowMonitorMap').hide();
                    if (!ticc.isNull(passengerFlowMonitorMap)){
                        baiduMapUtil.setMap(passengerFlowMonitorMap);
                    }else {
                        ticc.alertError('地图初始化失败')
                    }
                    stationSearch();
                    break;
                case 1://线路
                    //线路
                    if (!ticc.isNull(ac)){
                        ac.dispose();
                    }

                    $('#linePassengerFlowMonitorMap').show();
                    $('#passengerFlowMonitorMap').hide();
                    $('#brtPassengerFlowMonitorMap').hide();

                    lineNameSearch();
//                if (!ticc.isNull(markerClusterer)){
//                    markerClusterer.clearMarkers();
//                }
                    //清除所有标注物
//                passengerFlowMonitorMap.clearOverlays();
                    requestAllLine();
                    break;
                case 2://brt
                    //销毁线路
                    if (!ticc.isNull(lineChart)){
                        lineChart.dispose();
                    }
                    //解绑搜索框键盘释放的事件
                    $('#searchInput').unbind('keyup');

                    $('#linePassengerFlowMonitorMap').hide();
                    $('#passengerFlowMonitorMap').hide();
                    $('#brtPassengerFlowMonitorMap').show();
                    if (ticc.isNull(brtPassengerFlowMonitorMap)){
                        brtInitMap();
                    }else{
                        baiduMapUtil.setMap(brtPassengerFlowMonitorMap);
                    }
                    requestBrtZj();
//                    stationSearch();
                    break;
            }
        });

//        map.centerAndZoom(new BMap.Point(116.404, 39.915), 5);
//        map.enableScrollWheelZoom();


//        var MAX = 10;
//        var markers = [];
//        var pt = null;
//        var i = 0;
//        for (; i < MAX; i++) {
//            pt = new BMap.Point(Math.random() * 40 + 85, Math.random() * 30 + 21);
//            markers.push(new BMap.Marker(pt));
//        }
//        //最简单的用法，生成一个marker数组，然后调用markerClusterer类即可。
//        var markerClusterer = new BMapLib.MarkerClusterer(map, {markers:markers});


        /*#######################################*/

//        var compare = function (obj1, obj2) {
//            var val1 = obj1.name;
//            var val2 = obj2.name;
//            if (val1 < val2) {
//                return -1;
//            } else if (val1 > val2) {
//                return 1;
//            } else {
//                return 0;
//            }
//        };
        /*请求站点前10开始*/
        var stationLineCompare = function (obj1, obj2) {
            var val1 = obj2.stationFlow;
            var val2 = obj1.stationFlow;
            if (val1 < val2) {
                return -1;
            } else if (val1 > val2) {
                return 1;
            } else {
                return 0;
            }
        };
        var requestStationTop10 = function () {
            var path = basePath+'/redis/getStationFlowTop10';
            var param = {'date':new Date().format('yyyyMMdd')};
            ticc.ajaxRequest(path,param,function (result) {
//                alert(JSON.stringify(result))
                if(result.status){
                    if (!ticc.isNullOrEmpty(result.data)){
                        var passengerFlowSum = result.data.passengerFlowSum;
                        $('#passengerFlowSum').text(parseFloat(passengerFlowSum/10000));

                        $('#stationTop10').empty();
//                        alert(JSON.stringify(result.data.stationFlowTop10))
                        $.each(result.data.stationFlowTop10.sort(stationLineCompare),function (index,item) {
                            var obj = item;
//                            alert(key.StationLine)
//                            alert(JSON.stringify(key))
                            index += 1;
                            var stationName = obj.busStopName+'('+obj.bsDirection+')';
                            var stationFlow = item.stationFlow;
                            var percent =((stationFlow/passengerFlowSum)*100).toFixed(2);
                            if(!ticc.isNumber(percent)){
                                percent = 0;
                            }
//                            alert(JSON.stringify(index))
//                            alert(JSON.stringify(item))

                            var stationTop10Html = '<li><span class="rank-num"><em>'+index+'</em></span>';

                            stationTop10Html += '<div class="progress">' +
                                '                            <div class="info">' +
                                '                            <span class="name" title="'+stationName+'">'+stationName+'</span>' +
                                '                            <span class="name-right">'+stationFlow+'次 &nbsp; &nbsp;'+percent+'%</span>' +
                                '                        </div>' +
                                '<div class="progress-bar">' +
                                '                            <div class="progress-inner" style="width: '+percent+'%">' +
                                '                            </div>' +
                                '                            </div>' +
                                '                            </div>' +
                                '                            </li>';
                            $('#stationTop10').append(stationTop10Html);
                        });




//                        alert(JSON.stringify(result.data))
                    }else{
                        ticc.alertInfo(result.msg);
                    }
                }else{
                    ticc.alertError(result.msg);
                }
            });
        };
        requestStationTop10();
        /*请求站点前10结束*/

        /*#######################################*/

        /*请求线路前10开始*/
        var lineCompare = function (obj1, obj2) {
            var val1 = obj2.lineFlow;
            var val2 = obj1.lineFlow;
            if (val1 < val2) {
                return -1;
            } else if (val1 > val2) {
                return 1;
            } else {
                return 0;
            }
        };
        var requestLineTop10 = function () {
            var path = basePath+'/redis/getLineFlowTop10';
            var param = {'date':new Date().format('yyyyMMdd')};
            ticc.ajaxRequest(path,param,function (result) {
//                alert(JSON.stringify(result))
                if(result.status){
                    if (!ticc.isNullOrEmpty(result.data)){
                        var passengerFlowSum = result.data.passengerFlowSum;
                        $('#passengerFlowSum').text(parseFloat(passengerFlowSum/10000));

                        $('#lineTop10').empty();
//                        alert(JSON.stringify(result.data.stationFlowTop10))
                        $.each(result.data.lineFlowTop10.sort(lineCompare),function (index,item) {
                            index += 1;
//                            var lineName = item.lineName;
                            var lineName = item.nameForsHort;
                            var lineFlow = item.lineFlow;
                            var percent =((lineFlow/passengerFlowSum)*100).toFixed(2);
                            if(!ticc.isNumber(percent)){
                                percent = 0;
                            }
//                            alert(JSON.stringify(index))
//                            alert(JSON.stringify(item))

                            var lineTop10Html = '<li><span class="rank-num"><em>'+index+'</em></span>';

                            lineTop10Html += '<div class="progress">' +
                                '                            <div class="info">' +
                                '                            <span class="name" title="'+lineName+'">'+lineName+'</span>' +
                                '                            <span class="name-right">'+lineFlow+'次 &nbsp; &nbsp;'+percent+'%</span>' +
                                '                        </div>' +
                                '<div class="progress-bar">' +
                                '                            <div class="progress-inner" style="width: '+percent+'%">' +
                                '                            </div>' +
                                '                            </div>' +
                                '                            </div>' +
                                '                            </li>';
                            $('#lineTop10').append(lineTop10Html);
                        });

//                        alert(JSON.stringify(result.data))
                    }else{
                        ticc.alertInfo(result.msg);
                    }
                }else{
                    ticc.alertError(result.msg);
                }
            });
        };
        /*请求线路前10结束*/

        /*#######################################*/
        var lineChart;
        //显示全部线路开始
        var allLine = traffic;
        var lineBmap;
        var displayAllLine = function () {
            // 基于准备好的dom，初始化echarts实例
            lineChart = echarts.init(document.getElementById('linePassengerFlowMonitorMap'));

            var lineChartOption = {
                bmap: {
                    center: [113.3531911431, 23.1264654617],
                    zoom: 12,
                    roam: true,
//                    roam: false,
                    mapStyle: {
                        'styleJson':baiduMapStyle
                    },
                },
                series: [{
                    type: 'lines',
                    coordinateSystem: 'bmap',
                    polyline: true,
                    data: traffic,
                    silent: true,
                    lineStyle: {
                        normal: {
                            opacity: 0.2,
                            width: 1
                        }
                    },
                    progressiveThreshold: 500,
                    progressive: 100
                }, {
                    type: 'lines',
                    coordinateSystem: 'bmap',
                    polyline: true,
                    data: traffic,
                    lineStyle: {
                        normal: {
//                            width: 0.02
                            width: 0.2
                        }
                    },
                    effect: {
                        constantSpeed: 40,
                        show: true,
//                        trailLength: 0.02,
                        trailLength: 0.2,
                        symbolSize: 2
                    },
                    zlevel: 1
                }]

            };
            // 使用刚指定的配置项和数据显示图表。
            lineChart.setOption(lineChartOption);

            //百度地图
            lineBmap = lineChart.getModel().getComponent('bmap').getBMap();
            baiduMapUtil.setMap(lineBmap);
            //地图更改缩放级别结束时触发触发此事件
            // bmap.addEventListener('zoomend',function () {
            //     var baiduCenter = bmap.getCenter();
            //     var circle = new BMap.Circle(baiduCenter,500,{strokeColor:"blue", strokeWeight:2, strokeOpacity:0.5}); //创建圆
            //     bmap.addOverlay(circle);            //增加圆
            //     alert(JSON.stringify(baiduCenter));
            //
            // });
//            bmap.addEventListener("click", function () {
//                return false;
//            });
            lineEvent(lineChart);
        };
        //显示全部线路结束

        /*#######################################*/
        //请求全部线路详情开始
        var requestAllLine = function () {
            displayAllLine();
//            var path = basePath+'/redis/getLineDetails';
//            var param = null;
//            ticc.ajaxRequest(path,param,function (result) {
//                if(result.status){
//                    if (!ticc.isNullOrEmpty(result.data)){
//                        alert(JSON.stringify(result.data));
//                        displayAllLine();
//                    }else{
//                        ticc.alertInfo(result.msg);
//                    }
//                }else{
//                    ticc.alertError(result.msg);
//                }
//            });

        };
        //请求全部线路详情结束
        /*#######################################*/

        //线路点击事件开始
        var lineEvent = function (lineChart) {
            lineChart.on('click', function (params) {
                // 控制台打印数据的名称
//                alert(JSON.stringify(params.name));
                displayLineInfoBox(params.data);
//            console.log(params.name);
//            if ('series' == params.componentType&&'effectScatter' == params.seriesType){
////                 alert(JSON.stringify(params.value));
//                myChart.dispatchAction({
//                    type: 'legendSelect',
//                    // 图例名称
//                    name: params.name
//                });
//
//            }
            });
        };
        //线路点击事件结束

        /*#######################################*/
        //根据线路编号查找线路
        var requestLineByLineNo = function (lineNo) {
//            if(ticc.isNullOrEmpty(allLine)){
//                return;
//            }

            var path = basePath+'/redis/getLineDetails';
            var param = {'lineNo':lineNo};
            ticc.ajaxRequest(path,param,function (result) {
                if(result.status){
                    if (!ticc.isNullOrEmpty(result.data)){
//                        alert(JSON.stringify(result.data));
                        var lines = JSON.parse(result.data);
//                        lineBmap.setViewport($.map(lines[0].coords,function (item) {
//                            return new BMap.Point(item[0], item[1])
//                        }));
                        var middle = parseInt(lines[0].coords.length/2);
//            var baiduPoint = $.mapUtils.gps84_To_bd09(markerData.coords[middle][0],markerData.coords[middle][1]);
                        var baiduPoint = lines[0].coords[middle];
                        var lineChartOption = {
                            bmap: {
                                center: baiduPoint,
                                zoom: 14,
                                roam: true,
                                //                    roam: false,
                                mapStyle: {
                                    'styleJson':baiduMapStyle
                                },
                            },
                            series: [{
                                type: 'lines',
                                coordinateSystem: 'bmap',
                                polyline: true,
                                data: lines,
                                silent: true,
                                lineStyle: {
                                    normal: {
                                        opacity: 0.2,
                                        width: 5
                                    }
                                },
                                progressiveThreshold: 500,
                                progressive: 100
                            }, {
                                type: 'lines',
                                coordinateSystem: 'bmap',
                                polyline: true,
                                data: lines,
                                lineStyle: {
                                    normal: {
                                        width: 3
                                    }
                                },
                                effect: {
                                    constantSpeed: 40,
                                    show: true,
                                    trailLength: 0.5,
                                    symbolSize: 5
                                },
                                zlevel: 1
                            }]

                        };
                        lineChart.setOption(lineChartOption);

                    }else{
                        ticc.alertInfo(result.msg);
                    }
                }else{
                    ticc.alertError(result.msg);
                }
            });
        };

        /*#######################################*/

        //显示线路自定义信息窗体开始
        var lineInfoBox;
        var displayLineInfoBox = function (data) {
            var markerData = data;
            var path = basePath+'/redis/getLineFlow';
            var key = new Date().format("yyyyMMdd")+"-"+markerData.lineNo+"-"+markerData.upDown;
            var param = {'key':key};
            ticc.ajaxRequest(path,param,function (result) {
                if(result.status){
                    var direction = '未知';
                    if (markerData.upDown == '0'){
                        direction = '上行';
                    }else if (markerData.upDown == '1'){
                        direction = '下行';
                    }
                    var html = '<div class="online-car-msg">';
                    html += '<div>'+markerData.lineName+'（'+direction+'）</div>';
                    html += '<div>线路编号：'+markerData.lineNo+'</div>';
                    html += '<div>当前刷卡量：'+result.data+'人次</div>';
                    html += '<em></em></div>';

                    //如果infoBox不为空要关闭
                    if (!ticc.isNull(lineInfoBox)){
                        lineInfoBox.close();
                        lineInfoBox = null;
                    }
                    lineInfoBox = baiduMapUtil.createInfoBox(html,new BMap.Size(0, 20));
                    var middle = parseInt(markerData.coords.length/2);
//            var baiduPoint = $.mapUtils.gps84_To_bd09(markerData.coords[middle][0],markerData.coords[middle][1]);
                    var baiduPoint = markerData.coords[middle];
                    var posi = new BMap.Point(baiduPoint[0], baiduPoint[1]);
                    lineInfoBox.open(posi);
                    //防止默认的关闭按钮图片404
                    $('div.infoBox>img').prop('src','').css('display','none');
                    $('div.online-car-msg>em').on("click",function () {
                        lineInfoBox.close();
                    })
                }else{
                    ticc.alertError(result.msg);
                }
            });

//            alert(JSON.stringify(data));



        };
        //显示线路自定义信息窗体结束

        /*#######################################*/
/*        setInterval(function () {
            requestAllStation();
        },5000);*/
        /*#######################################*/

        //请求brt闸机开始
        var requestBrtZj = function () {
            var path = basePath+'/stationLine/getBrtZj';
            var param = null;
            ticc.ajaxRequest(path,param,function (result) {
//                alert(JSON.stringify(result))
                if(result.status){
                    if (!ticc.isNullOrEmpty(result.data)){
                        displayBrtZj(result.data);
//                        alert(JSON.stringify(result.data))
                    }else{
                        ticc.alertInfo(result.msg);
                    }
                }else{
                    ticc.alertError(result.msg);
                }
            });
        };
        //请求brt闸机结束

        /*#######################################*/

        /*显示站点开始*/
        var brtZjMarkers;
        //信息窗体
        var brtInfoBox;
        var displayBrtZj = function (data) {
            var baiduPoints =[];
            $.each(data,function (index,item) {
                baiduPoints.push(new BMap.Point(item.longitudeBd, item.latitudeBd));
            });
            var posIcon = new BMap.Icon(
                basePath+'/static/busAnalysisDisplay/images/station_normal.png',
//                '/busAnalysisSys/static/busAnalysisDisplay/images/station_normal.png',
                new BMap.Size(20,40)
            );
            var markerOptions = {icon:posIcon,rotation:0};
            console.log('BRT闸机和挂墙个数：'+baiduPoints.length);
            brtZjMarkers =  baiduMapUtil.addMarker(baiduPoints,markerOptions,'click',function (marker) {
                var markerData = marker.data;
                //获取站点客流量和站点客流量小时变化
                var path = basePath+'/redis/getStationFlowHourChange';
                var date=new Date();
                var month=date.getMonth()+1;
                var day=date.getDate();
                var key = (date.format('yyyyMMdd'))+'-'+markerData.busStopCode+'-'+markerData.upDown;
                var param = {'key':key};
                ticc.ajaxRequest(path,param,function (result) {
                    if(result.status){
                        if (!ticc.isNullOrEmpty(result.data)){
                            var html = '<div class="keliu-form"><div>站点名：'+markerData.busStopName+'('+markerData.bsDirection+')</div>';
                            html += '<div class="p-bottom">'+month+'月'+day+'日客流量变化表</div>';
                            html += '<div class="keliu-form-con" style="position: relative"><div id="passengerFlowChangChart" class="chartStyle"></div></div>';
                            html += '<div class="p-top">当前客流量：'+result.data.stationCurrentFlow+'人次</div>';
                            html += '<em></em>';
                            html += '<span class="down-arrow"></span></div>';

                            //如果infoBox不为空要关闭
                            if (!ticc.isNull(brtInfoBox)){
                                brtInfoBox.close();
                                brtInfoBox = null;
                            }
                            brtInfoBox = baiduMapUtil.createInfoBox(html);
                            brtInfoBox.open(marker);
                            //防止默认的关闭按钮图片404
                            $('div.infoBox>img').prop('src','').css('display','none');
                            $('div.keliu-form>em').on("click",function () {
                                brtInfoBox.close();
                            });

                            //显示客流变量变化曲线图
                            dispalyPassengerFlowChangChart(result.data.hoursFlowChangeDataMap);
                        }else{
                            ticc.alertInfo(result.msg);
                        }
                    }else{
                        ticc.alertError(result.msg);
                    }
                });
            },data);
//            brtMarkerClusterer = baiduMapUtil.addMarkerClusterer(baiduPoints,markerOptions,'click',function (marker) {
//                var markerData = marker.data;
//                //获取站点客流量和站点客流量小时变化
//                var path = basePath+'/redis/getStationFlowHourChange';
//                var date=new Date();
//                var month=date.getMonth()+1;
//                var day=date.getDate();
//                var key = (date.format('yyyyMMdd'))+'-'+markerData.busStopCode+'-'+markerData.upDown;
//                var param = {'key':key};
//                ticc.ajaxRequest(path,param,function (result) {
////                alert(JSON.stringify(result))
//                    if(result.status){
//                        if (!ticc.isNullOrEmpty(result.data)){
//
//
//
////                alert(JSON.stringify(markerData));
////                var html = '<div class="online-car-msg" style="width: 400px;height: 300px"><em></em></div>';
//                            var html = '<div class="keliu-form"><div>站点名：'+markerData.busStopName+'('+markerData.bsDirection+')</div>';
//                            html += '<div class="p-bottom">'+month+'月'+day+'日客流量变化表</div>';
//                            html += '<div class="keliu-form-con" style="position: relative"><div id="passengerFlowChangChart" class="chartStyle"></div></div>';
//                            html += '<div class="p-top">当前客流量：'+result.data.stationCurrentFlow+'人次</div>';
//                            html += '<em></em>';
//                            html += '<span class="down-arrow"></span></div>';
//
//                            //如果infoBox不为空要关闭
//                            if (!ticc.isNull(infoBox)){
//                                infoBox.close();
//                                infoBox = null;
//                            }
//                            brtInfoBox = baiduMapUtil.createInfoBox(html);
////                infoBox.open(marker.getPosition());
//                            brtInfoBox.open(marker);
////                infoBox.setPosition(marker.getPosition());
//                            //防止默认的关闭按钮图片404
//                            $('div.infoBox>img').prop('src','').css('display','none');
////                $('div.infoBox>img').css('display','none');
//                            $('div.keliu-form>em').on("click",function () {
//                                infoBox.close();
//                            });
//
//                            //显示客流变量变化曲线图
//                            dispalyPassengerFlowChangChart(result.data.hoursFlowChangeDataMap);
////            <div class="online-car-msg ">
////                    <div>粤A123456    24.32km/h</div>
////                <div>532路（上行） | 一汽一公司 | 邓某某</div>
////                <div>当前站点：体育中心站</div>
////                <div>当前刷卡量：4852人次</div>
////                <em></em>
////                </div>
//
////                var d = marker.data;
////
////                var posi = marker.getPosition();
////                var htmlContent = "设备编号:<strong>"+d.equipNo+"</strong>";
////                baiduMapUtil.openInfoWindow(htmlContent,posi);
//
//
//                        }else{
//                            ticc.alertInfo(result.msg);
//                        }
//                    }else{
//                        ticc.alertError(result.msg);
//                    }
//                });
//
//            },null,null,null,data,20);
        };
        /*显示站点结束*/

        /*#######################################*/
    });
</script>
</html>